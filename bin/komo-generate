#!/usr/bin/env ruby
# encoding: utf-8
require 'optparse'

base   = File.symlink?(__FILE__) ? File.readlink(__FILE__) : __FILE__
libdir = File.expand_path(File.join(File.dirname(base), "..", "lib"))

$:.unshift(libdir) unless $:.include?(libdir)

ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../../Gemfile", __FILE__)

require "rubygems"
require "bundler/setup"

require 'komo'

working_dir	= Dir.pwd
branch      = 'master'

opt = OptionParser.new
opt.version = Komo::VERSION
opt.on("-w", "--working_dir GIT_REPOSITORY") {|v| working_dir = v }
opt.on("-b", "--branch BRANCH") { |v| branch = v }
opt.parse!

require 'komo/builder'

DataMapper::Logger.new($stdout, :debug)
DataMapper.setup(:default, "sqlite:///#{working_dir}/index.db")


Komo::Builder.new.build(
  working_dir: working_dir,
  branch: branch
)
